tasks.create("buildSnap") {
    group "build"
    doFirst {
        if(System.getProperty("os.name") != "Linux") {
            throw new GradleException("Snaps can only be built on Linux.")
        }

    	new File('snap/local').mkdirs()
        def snapcraftFile = new File('snap/snapcraft.yaml')
        def origSnapcraftFile = new File('snap/local/snapcraft.yaml.orig')
        origSnapcraftFile.write(snapcraftFile.text)
    }

    doLast {
        def origSnapcraftFile = new File('snap/local/snapcraft.yaml.orig')
        def snapcraftFile = new File('snap/snapcraft.yaml')
        snapcraftFile.withWriter { w ->
            origSnapcraftFile.eachLine { line ->
                if(line.startsWith("version:")) {
                    w << "version: '" + appVersion + "'\n"
                } else {
                    w << line + "\n"
                }
            }
        }

        exec {
            commandLine "snapcraft"
        }

        snapcraftFile.write(origSnapcraftFile.text)
        delete("./snap/local/snapcraft.yaml.orig")
    }
}
